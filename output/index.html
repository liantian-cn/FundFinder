<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <meta charset="utf-8" />
    <title>FundFinder</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="dataTables.bootstrap4.min.css">
    <script src="jquery.min.js"></script>
    <script src="bootstrap.bundle.min.js"></script>
    <script src="jquery.dataTables.min.js"></script>

    <script src="dataTables.bootstrap4.min.js"></script>
</head>

<body style="height: 100%;">


    <nav class="navbar navbar-expand navbar-light bg-light">
        <span class="navbar-brand mb-0 h1" id="pageTitle">天天Fund</span>
    </nav>
    <div class="container-fluid">
        <table id="indexTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>指数代码</th>
                    <th>指数名称</th>
                    <th>股息率</th>
                    <th>市盈率</th>
                    <th>市净率</th>
                    <th>基金总数</th>
                    <th>估值百分位</th>
                    <th>估值网格收益</th>
                    <th>布林网格收益</th>
                    <th>估值买卖点</th>
                    <th>布林买卖点</th>
                    <th>详情</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

</body>
<script>
    $(document).ready(function () {
        fetch(`index/home.json`)
            .then(response => response.json())
            .then(data => {
                // 预处理数据，提取股息率、市盈率、市净率、估值百分位用于染色计算
                const processedData = data.map(item => {
                    let dyrValue = null;
                    let peValue = null;
                    let pbValue = null;
                    let valuationValue = null;
                    let fundamentalRateValue = null;  // 估值网格收益
                    let bollingerRateValue = null;    // 布林网格收益

                    if (item.股息率 !== undefined && item.股息率 !== null) {
                        dyrValue = parseFloat(item.股息率);
                    }
                    if (item.市盈率 !== undefined && item.市盈率 !== null) {
                        peValue = parseFloat(item.市盈率);
                    }
                    if (item.市净率 !== undefined && item.市净率 !== null) {
                        pbValue = parseFloat(item.市净率);
                    }
                    if (item.估值百分位 !== undefined && item.估值百分位 !== null) {
                        valuationValue = parseFloat(item.估值百分位);
                    }
                    if (item.fundamental_rate !== undefined && item.fundamental_rate !== null) {
                        fundamentalRateValue = parseFloat(item.fundamental_rate);
                    }
                    if (item.bollinger_rate !== undefined && item.bollinger_rate !== null) {
                        bollingerRateValue = parseFloat(item.bollinger_rate);
                    }

                    // 提取买卖点数据
                    let fundamentalBuyPrice = item.fundamental_buy_price !== undefined && item.fundamental_buy_price !== null ? 
                                              Math.round(parseFloat(item.fundamental_buy_price) * 100) : null;
                    let fundamentalSellPrice = item.fundamental_sell_price !== undefined && item.fundamental_sell_price !== null ? 
                                               Math.round(parseFloat(item.fundamental_sell_price) * 100) : null;
                    let bollingerBuyPrice = item.bollinger_buy_price !== undefined && item.bollinger_buy_price !== null ? 
                                            Math.round(parseFloat(item.bollinger_buy_price) * 100) : null;
                    let bollingerSellPrice = item.bollinger_sell_price !== undefined && item.bollinger_sell_price !== null ? 
                                             Math.round(parseFloat(item.bollinger_sell_price) * 100) : null;

                    return {
                        ...item,
                        dyrValue: dyrValue,
                        peValue: peValue,
                        pbValue: pbValue,
                        valuationValue: valuationValue,
                        fundamentalRateValue: fundamentalRateValue,
                        bollingerRateValue: bollingerRateValue,
                        fundamentalBuyPrice: fundamentalBuyPrice,
                        fundamentalSellPrice: fundamentalSellPrice,
                        bollingerBuyPrice: bollingerBuyPrice,
                        bollingerSellPrice: bollingerSellPrice
                    };
                });

                // 计算各项指标的最大值和最小值用于染色
                const validDyrValues = processedData
                    .map(item => item.dyrValue)
                    .filter(value => value !== null);
                const validPeValues = processedData
                    .map(item => item.peValue)
                    .filter(value => value !== null);
                const validPbValues = processedData
                    .map(item => item.pbValue)
                    .filter(value => value !== null);
                const validValuationValues = processedData
                    .map(item => item.valuationValue)
                    .filter(value => value !== null);
                const validFundamentalRateValues = processedData
                    .map(item => item.fundamentalRateValue)
                    .filter(value => value !== null);
                const validBollingerRateValues = processedData
                    .map(item => item.bollingerRateValue)
                    .filter(value => value !== null);

                const maxDyr = validDyrValues.length > 0 ? Math.max(...validDyrValues) : 0;
                const minDyr = validDyrValues.length > 0 ? Math.min(...validDyrValues) : 0;
                const dyrRange = maxDyr - minDyr;

                const maxPe = validPeValues.length > 0 ? Math.max(...validPeValues) : 0;
                const minPe = validPeValues.length > 0 ? Math.min(...validPeValues) : 0;
                const peRange = maxPe - minPe;

                const maxPb = validPbValues.length > 0 ? Math.max(...validPbValues) : 0;
                const minPb = validPbValues.length > 0 ? Math.min(...validPbValues) : 0;
                const pbRange = maxPb - minPb;

                const maxValuation = validValuationValues.length > 0 ? Math.max(...validValuationValues) : 0;
                const minValuation = validValuationValues.length > 0 ? Math.min(...validValuationValues) : 0;
                const valuationRange = maxValuation - minValuation;

                const maxFundamentalRate = validFundamentalRateValues.length > 0 ? Math.max(...validFundamentalRateValues) : 0;
                const minFundamentalRate = validFundamentalRateValues.length > 0 ? Math.min(...validFundamentalRateValues) : 0;
                const fundamentalRateRange = maxFundamentalRate - minFundamentalRate;

                const maxBollingerRate = validBollingerRateValues.length > 0 ? Math.max(...validBollingerRateValues) : 0;
                const minBollingerRate = validBollingerRateValues.length > 0 ? Math.min(...validBollingerRateValues) : 0;
                const bollingerRateRange = maxBollingerRate - minBollingerRate;

                const tableData = processedData.map(item => [
                    item.日期,
                    item.股票代码,
                    item.name,
                    item.股息率 !== undefined && item.股息率 !== null ? (item.股息率 * 100).toFixed(2) + '%' : 'N/A',
                    item.市盈率 !== undefined && item.市盈率 !== null ? item.市盈率.toFixed(2) : 'N/A',
                    item.市净率 !== undefined && item.市净率 !== null ? item.市净率.toFixed(2) : 'N/A',
                    item.tracking_fund_count,
                    item.估值百分位 !== undefined && item.估值百分位 !== null ? (item.估值百分位 * 100).toFixed(2) + '%' : 'N/A',
                    item.fundamental_rate !== undefined && item.fundamental_rate !== null ? (item.fundamental_rate * 100).toFixed(2) + '%' : 'N/A',
                    item.bollinger_rate !== undefined && item.bollinger_rate !== null ? (item.bollinger_rate * 100).toFixed(2) + '%' : 'N/A',
                    item.fundamentalBuyPrice !== null && item.fundamentalSellPrice !== null ? 
                      `${item.fundamentalBuyPrice}/${item.fundamentalSellPrice}` : 'N/A',
                    item.bollingerBuyPrice !== null && item.bollingerSellPrice !== null ? 
                      `${item.bollingerBuyPrice}/${item.bollingerSellPrice}` : 'N/A',
                    `<a href="/fund.html?stockCode=${item.股票代码}">详情</a>`,
                    item.dyrValue, // 隐藏列，用于染色计算
                    item.peValue,  // 隐藏列，用于染色计算
                    item.pbValue,  // 隐藏列，用于染色计算
                    item.valuationValue // 隐藏列，用于染色计算
                ]);

                $('#indexTable').DataTable({
                    data: tableData,
                    columns: [
                        { title: "日期" },
                        { title: "指数代码" },
                        { title: "指数名称" },
                        { title: "股息率" },
                        { title: "市盈率" },
                        { title: "市净率" },
                        { title: "基金总数" },
                        { title: "估值百分位" },
                        { title: "估值网格收益" },
                        { title: "布林网格收益" },
                        { title: "估值买卖点" },
                        { title: "布林买卖点" },
                        { title: "详情" },
                        { title: "股息率값", visible: false }, // 隐藏列
                        { title: "市盈率C", visible: false }, // 隐藏列
                        { title: "市净率C", visible: false }, // 隐藏列
                        { title: "估值百分位C", visible: false } // 隐藏列
                    ],
                    order: [[0, 'desc']],
                    paging: false,
                    createdRow: function (row, data, dataIndex) {
                        // 股息率染色（高绿色，低红色）
                        const dyrValue = data[13]; // 第14列是隐藏的股息率值
                        const dyrCell = $('td', row).eq(3); // 第4列是股息率显示列

                        if (dyrValue !== null && dyrRange > 0) {
                            const ratio = (dyrValue - minDyr) / dyrRange;
                            const hue = ratio * 120; // 0 = red, 120 = green
                            const color = `hsl(${hue}, 80%, 85%)`;
                            dyrCell.css('background-color', color);
                        }

                        // 估值百分位染色（高红色，低绿色）
                        const valuationValue = data[16]; // 第17列是隐藏的估值百分位값
                        const valuationCell = $('td', row).eq(7); // 第8列是估值百分位显示列

                        if (valuationValue !== null && valuationRange > 0) {
                            const ratio = (valuationValue - minValuation) / valuationRange;
                            const hue = 120 - (ratio * 120); // 120 = green, 0 = red
                            const color = `hsl(${hue}, 80%, 85%)`;
                            valuationCell.css('background-color', color);
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    });
</script>

</html>