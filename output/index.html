<!DOCTYPE html>
<html style="height: 100%;">

<head>
    <meta charset="utf-8" />
    <title>FundFinder</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="dataTables.bootstrap4.min.css">
    <script src="jquery.min.js"></script>
    <script src="bootstrap.bundle.min.js"></script>
    <script src="jquery.dataTables.min.js"></script>

    <script src="dataTables.bootstrap4.min.js"></script>
</head>

<body style="height: 100%;">


    <nav class="navbar navbar-expand navbar-light bg-light">
        <span class="navbar-brand mb-0 h1" id="pageTitle">天天Fund</span>
    </nav>
    <div class="container-fluid">
        <table id="indexTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>指数代码</th>
                    <th>指数名称</th>
                    <th>股息率</th>
                    <th>市盈率</th>
                    <th>市净率</th>
                    <th>基金总数</th>
                    <th>估值百分位</th>
                    <th>最佳网格年化收益率</th>
                    <th>详情</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

</body>
<script>
    $(document).ready(function () {
        fetch(`index/home.json`)
            .then(response => response.json())
            .then(data => {
                // 预处理数据，提取股息率、市盈率、市净率、估值百分位用于染色计算
                const processedData = data.map(item => {
                    let dyrValue = null;
                    let peValue = null;
                    let pbValue = null;
                    let valuationValue = null;

                    if (item.股息率 !== undefined && item.股息率 !== null) {
                        dyrValue = parseFloat(item.股息率);
                    }
                    if (item.市盈率 !== undefined && item.市盈率 !== null) {
                        peValue = parseFloat(item.市盈率);
                    }
                    if (item.市净率 !== undefined && item.市净率 !== null) {
                        pbValue = parseFloat(item.市净率);
                    }
                    if (item.估值百分位 !== undefined && item.估值百分位 !== null) {
                        valuationValue = parseFloat(item.估值百分位);
                    }

                    return {
                        ...item,
                        dyrValue: dyrValue,
                        peValue: peValue,
                        pbValue: pbValue,
                        valuationValue: valuationValue
                    };
                });

                // 计算各项指标的最大值和最小值用于染色
                const validDyrValues = processedData
                    .map(item => item.dyrValue)
                    .filter(value => value !== null);
                const validPeValues = processedData
                    .map(item => item.peValue)
                    .filter(value => value !== null);
                const validPbValues = processedData
                    .map(item => item.pbValue)
                    .filter(value => value !== null);
                const validValuationValues = processedData
                    .map(item => item.valuationValue)
                    .filter(value => value !== null);

                const maxDyr = validDyrValues.length > 0 ? Math.max(...validDyrValues) : 0;
                const minDyr = validDyrValues.length > 0 ? Math.min(...validDyrValues) : 0;
                const dyrRange = maxDyr - minDyr;

                const maxPe = validPeValues.length > 0 ? Math.max(...validPeValues) : 0;
                const minPe = validPeValues.length > 0 ? Math.min(...validPeValues) : 0;
                const peRange = maxPe - minPe;

                const maxPb = validPbValues.length > 0 ? Math.max(...validPbValues) : 0;
                const minPb = validPbValues.length > 0 ? Math.min(...validPbValues) : 0;
                const pbRange = maxPb - minPb;

                const maxValuation = validValuationValues.length > 0 ? Math.max(...validValuationValues) : 0;
                const minValuation = validValuationValues.length > 0 ? Math.min(...validValuationValues) : 0;
                const valuationRange = maxValuation - minValuation;

                const tableData = processedData.map(item => [
                    item.日期,
                    item.股票代码,
                    item.name,
                    item.股息率 !== undefined && item.股息率 !== null ? (item.股息率 * 100).toFixed(2) + '%' : 'N/A',
                    item.市盈率 !== undefined && item.市盈率 !== null ? item.市盈率.toFixed(2) : 'N/A',
                    item.市净率 !== undefined && item.市净率 !== null ? item.市净率.toFixed(2) : 'N/A',
                    item.tracking_fund_count,
                    item.估值百分位 !== undefined && item.估值百分位 !== null ? (item.估值百分位 * 100).toFixed(2) + '%' : 'N/A',
                    item.backtest_avg !== undefined && item.backtest_avg !== null ? (item.backtest_avg * 100).toFixed(2) + '%' : 'N/A',
                    `<a href="/fund.html?stockCode=${item.股票代码}">详情</a>`,
                    item.dyrValue, // 隐藏列，用于染色计算
                    item.peValue,  // 隐藏列，用于染色计算
                    item.pbValue,  // 隐藏列，用于染色计算
                    item.valuationValue // 隐藏列，用于染色计算
                ]);

                $('#indexTable').DataTable({
                    data: tableData,
                    columns: [
                        { title: "日期" },
                        { title: "指数代码" },
                        { title: "指数名称" },
                        { title: "股息率" },
                        { title: "市盈率" },
                        { title: "市净率" },
                        { title: "基金总数" },
                        { title: "估值百分位" },
                        { title: "平均网格年化收益率" },
                        { title: "详情" },
                        { title: "股息率值", visible: false }, // 隐藏列
                        { title: "市盈率C", visible: false }, // 隐藏列
                        { title: "市净率C", visible: false }, // 隐藏列
                        { title: "估值百分위C", visible: false } // 隐藏列
                    ],
                    order: [[0, 'desc']],
                    paging: false,
                    createdRow: function (row, data, dataIndex) {
                        // 股息率染色（高绿色，低红色）
                        const dyrValue = data[10]; // 第11列是隐藏的股息率값
                        const dyrCell = $('td', row).eq(3); // 第4列是股息率显示列

                        if (dyrValue !== null && dyrRange > 0) {
                            const ratio = (dyrValue - minDyr) / dyrRange;
                            const hue = ratio * 120; // 0 = red, 120 = green
                            const color = `hsl(${hue}, 80%, 85%)`;
                            dyrCell.css('background-color', color);
                        }

                        // 市盈率染色（高红色，低绿色）
                        const peValue = data[11]; // 第12列是隐藏的市盈率값
                        const peCell = $('td', row).eq(4); // 第5列是市盈率显示列

                        if (peValue !== null && peRange > 0) {
                            const ratio = (peValue - minPe) / peRange;
                            const hue = 120 - (ratio * 120); // 120 = green, 0 = red
                            const color = `hsl(${hue}, 80%, 85%)`;
                            peCell.css('background-color', color);
                        }

                        // 市净率染色（高红色，低绿色）
                        const pbValue = data[12]; // 第13列是隐藏的市净率값
                        const pbCell = $('td', row).eq(5); // 第6列是市净率显示列

                        if (pbValue !== null && pbRange > 0) {
                            const ratio = (pbValue - minPb) / pbRange;
                            const hue = 120 - (ratio * 120); // 120 = green, 0 = red
                            const color = `hsl(${hue}, 80%, 85%)`;
                            pbCell.css('background-color', color);
                        }

                        // 估值百分位染色（高红色，低绿色）
                        const valuationValue = data[13]; // 第14列是隐藏的估值百分位값
                        const valuationCell = $('td', row).eq(7); // 第8列是估值百分位显示列

                        if (valuationValue !== null && valuationRange > 0) {
                            const ratio = (valuationValue - minValuation) / valuationRange;
                            const hue = 120 - (ratio * 120); // 120 = green, 0 = red
                            const color = `hsl(${hue}, 80%, 85%)`;
                            valuationCell.css('background-color', color);
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
    });
</script>

</html>